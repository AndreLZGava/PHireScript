#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use App\Transpiler;

if ($argc < 3) {
    echo "Use: php bin/phps <origin_dir> <destiny_dir>\n";
    echo "Example: php bin/phps src dist\n";
    exit(1);
}

$sourceDir = rtrim($argv[1], '/');
$distDir = rtrim($argv[2], '/');
$transpiler = new Transpiler();

if (!is_dir($sourceDir)) {
    echo "Error: Directory '$sourceDir' not found.\n";
    exit(1);
}

if (is_dir($distDir)) {
    echo "Cleaning destination directory: $distDir...\n";
    cleanDirectory($distDir);
} else {
    mkdir($distDir, 0755, true);
}

$directory = new RecursiveDirectoryIterator($sourceDir, RecursiveDirectoryIterator::SKIP_DOTS);
$iterator = new RecursiveIteratorIterator($directory);

foreach ($iterator as $file) {
    if ($file->getExtension() === 'ps') {
        $relativePath = substr($file->getPathname(), strlen($sourceDir) + 1);

        $outputFile = $distDir . '/' . str_replace('.ps', '.php', $relativePath);

        $outputSubDir = dirname($outputFile);
        if (!is_dir($outputSubDir)) {
            mkdir($outputSubDir, 0755, true);
        }

        compileFile($file->getPathname(), $outputFile, $transpiler);
    }
}

function cleanDirectory($dir) {
    $files = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($dir, RecursiveDirectoryIterator::SKIP_DOTS),
        RecursiveIteratorIterator::CHILD_FIRST
    );

    foreach ($files as $fileinfo) {
        $todo = ($fileinfo->isDir() ? 'rmdir' : 'unlink');
        $todo($fileinfo->getRealPath());
    }
}

function compileFile($input, $output, $transpiler) {
    try {
        $sourceCode = file_get_contents($input);
        $result = $transpiler->compile($sourceCode);

        file_put_contents($output, $result);

        // --- NOVO: Verificação de Sintaxe (Lint) ---
        $output_text = [];
        $return_var = 0;
        // Executa: php -l path/to/file.php
        exec("php -l " . escapeshellarg($output), $output_text, $return_var);

        if ($return_var !== 0) {
            echo "✗ Syntax Error in generated file $output:\n";
            echo implode("\n", $output_text) . "\n";
            // Opcional: deletar o arquivo se estiver com erro
            // unlink($output);
        } else {
            echo "✓ $input -> $output\n";
        }

    } catch (Exception $e) {
        echo "✗ Error in $input: " . $e->getMessage() . "\n";
    }
}
