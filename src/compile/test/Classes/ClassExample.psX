// 1. O Type (Shape do dado)
type UserCredentials = {
    < String login // > will provide a public getLogin method to it without the need of create that
    < Email userEmail // Email will be a super type as Primitive, its a string but will be validated by a regex
    // +< Will provide a protected getDate and +> will provide a protected setDate for a protected dateBirth variable
    +< +> + Date dateBirth // Same as email but this will use date time functions/php class protected
    # IPV4 lastIp // as Email will be a string for php but wil lbe validated as a IPV4 class with regex // # private
}

// 2. A Interface (O Contrato)
interface Authenticator {
    String role
    authenticate(UserCredentials creds): Bool
    logout(): Void
}

// 3. Os Mixins (Traits para herança múltipla conceitual)
trait Logger {
    log(String msg) => echo "[LOG]: " + msg
}

trait PermissionChecker {
    hasRole?(String role): Bool => this.role == role
}

// 4. A Classe Completa
// Usamos 'extends' para a base e 'with' para os mixins (herança múltipla)
class AdminUser extends BaseUser with Logger, PermissionChecker implements Authenticator {

    // Propriedades com tipos do PHPScript
    String role = 'admin'
    UserCredentials credentials

    // Constructor simplificado
    constructor(
        String name,
        UserCredentials creds,
        UserRepository userRepository
    ) {
        super(name) // Chama o BaseUser
        this.credentials = creds
        this.log("Admin " + name + " instanciado")
    }

    // Implementação da Interface
    authenticate(UserCredentials creds): Bool {
        if (this.isSameLogin?(creds.login, this.credentials.login)) {
            this.log("Login realizado com sucesso")
            return true
        }
        return false
    }

    // # is for private
    // ? and ! allowed for end of method name, ? (Bool) ! (void)
    # isSameLogin?(String login, String userLogin): Bool {
        return login == userLogin
    }

    logout!(): Void {
        this.log("Sessão encerrada")
    }

    deleteAllUsers!() {
        this.userRepository.all().each(user => this.deleteUser!(user.id))
    }

    // Método usando lógica de Mixin
    // Protected methods +
    + async deleteUser!(Int id) {
        if (this.hasRole?('super-admin')) {
            echo "Utilizador " + id + " removido"
        } else {
            this.log("Acesso negado para remover utilizadores")
        }
    }
}
